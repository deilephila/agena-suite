<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
</head>
<body>
<input type="file" id="input">
<div id="out">
</div>
<table id="output"></table>
<script>
    const input = document.getElementById("input");
    const out = document.getElementById("out");

    function handleFile(file) {
      //  console.log("file:", file);
        let reader = new FileReader();
        reader.onload = () => {
         //   console.log("readed",reader.result)
            regexSearch(reader.result)
        };
        reader.readAsText(file);
    }

    function regexSearch(text) {
        //const regex = /assayId="(.*?)".*?mass="(.*?)".*?snr="(.*?)"/g;
        const regex = /<record.*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*?\w="(.*?)".*\/>/g
        const matched = [... text.matchAll(regex)];
        console.log("matched",matched);
        let primObj = makeObject(matched);
        let grouped = groupObj(primObj);
        let calculated = calculations(grouped);
        renderResult(calculated)
      //  renderResultAll(matched);
    }

    const makeObject = (matched) =>
        matched.map(oneString => {
            return {
                wellPosition: oneString[28],
                assayId: oneString[3],
                peakType: oneString[18],
                description: oneString[8],
                genotypeId: oneString[12],
                height: oneString[13]
            }
        })

    function groupObj (primObj) {
        let grouped = [];
        let wells = Object.groupBy(primObj, ({ wellPosition}) => wellPosition);
        let arrayOfKeys = Object.keys(wells);
        arrayOfKeys.forEach(key => {
            let a = key;
            let oneWell = wells[a];
            let result = Object.groupBy(oneWell, ({assayId}) => assayId);
            grouped.push(result)
        })
        return grouped
    }

  /*  function toSort (grouped) {
        grouped.forEach (well => {

        })
    } */

    function calculations (grouped) {
        grouped.forEach(well => {
            let arrayOfKeys = Object.keys(well);
            arrayOfKeys.forEach (rs => {
                let UEPheight = parseFloat(well[rs][0].height);
                for (let i=1; i<well[rs].length; i++) {
                    let EPheight = parseFloat(well[rs][i].height);
                    let ratio = EPheight ? Math.round((UEPheight / EPheight)*100)/100 : "no EP";
                    if (ratio == 0) {
                        ratio = "no UEP"
                    }
                    well[rs][i].ratio = ratio;
                }
            })
        })
        console.log(grouped)
        return grouped;
    }


    function renderResult(calculated) {
    let html = `<tr>
        <th>Well</th>
        <th>assayId</th>
        <th>Allele</th>
        <th>Quality</th>
        <th>PeakType</th>
        <th>UEP/EP</th>
        </tr>`
    calculated.forEach((well) => {
        let arrayOfKeys = Object.keys(well);
        arrayOfKeys.forEach (rs => {
            for (let i=1; i < well[rs].length; i++) {
                html += `<tr>
                    <td>${well[rs][i].wellPosition}</td>
                    <td>${well[rs][i].assayId}</td>
                    <td>${well[rs][i].genotypeId}</td>
                    <td>${well[rs][i].description}</td>
                    <td>${well[rs][i].peakType}</td>
                    <td>${well[rs][i].ratio}</td>
                </tr>`;
            }
            html += `<tr>
                    <td>${well[rs][0].wellPosition}</td>
                    <td> </td>
                    <td> </td>
                    <td> </td>
                    <td> </td>
                    <td> </td>
                </tr>`;
        })
    })
    document.getElementById("output").innerHTML = html;
}


 /*   function renderResult(calculated) {
        let header = ["Well", "assayId", "Allele", "Quality", "PeakType", "UEP/EP"];
        const table = document.createElement("table");

        let rowHeaderElement = document.createElement("tr");
        header.forEach(v => {
            let valueElement = document.createElement("td");
            valueElement.innerText = v;
            rowHeaderElement.appendChild(valueElement);
        })
        table.appendChild(rowHeaderElement);

        calculated.forEach (well =>  {
            let arrayOfKeys = Object.keys(well);
            arrayOfKeys.forEach (rs => {
                let rowElement = document.createElement("tr");
                let valueElement1 = document.createElement("td");
                valueElement.innerText = well[rs][0].wellPosition;
                let valueElement = document.createElement("td");
                rowElement.appendChild(valueElement);
                table.appendChild(rowElement);
            })
        
        })

        out.appendChild(table);
    } */

    function renderResultAll(res) {
        // cleaning before start
        while (out.childElementCount > 0) out.removeChild(out.children[0]);

        const regexForHeader = /(\w+)=/g
        let preHeader = [... res[0][0].matchAll(regexForHeader)];
        let header = [];
        preHeader.forEach(v => {
            header.push(v[1])
        });
     //   console.log("header",header);

        const table = document.createElement("table");

        let rowHeaderElement = document.createElement("tr");
        header.forEach(v => {
            let valueElement = document.createElement("td");
            let button = document.createElement("button");
            button.innerText = v;
            valueElement.appendChild(button);
            button.addEventListener('click',() => hider(v));
            valueElement.classList.add(v);
            rowHeaderElement.appendChild(valueElement);
        })
        table.appendChild(rowHeaderElement);

        res.forEach(row => {
            let rowElement = document.createElement("tr");
            row.shift(1);
            let i = 0;
            row.forEach(v => {
                let valueElement = document.createElement("td");
                valueElement.innerText = v.replaceAll(".",",");
                valueElement.classList.add(header[i]);
                rowElement.appendChild(valueElement);
                i++;
            })
            table.appendChild(rowElement);
        })
        out.appendChild(table);

    }

let style = (function() {
    let style = document.createElement("style");
    style.appendChild(document.createTextNode(""));
    document.head.appendChild(style);
    console.log(style.sheet.cssRules);
    return style;
})();



    function hider(h) {
        style.sheet.insertRule(`.${h}{display:none;}`);
    }

    input.addEventListener("change",(e)=>handleFile(e.target.files[0]));
</script>
</body>
</html>